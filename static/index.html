<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="bg-gray-100 h-screen">
<div id="root" class="h-full"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
        const [user, setUser] = useState(null);
        const [token, setToken] = useState(localStorage.getItem('token') || '');
        const [view, setView] = useState('login');
        const [loginForm, setLoginForm] = useState({ username: '', password: '' });
        const [registerForm, setRegisterForm] = useState({ username: '', password: '', email: '' });
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [ws, setWs] = useState(null);
        const [error, setError] = useState('');
        const [onlineUsers, setOnlineUsers] = useState([]);
        const [selectedUser, setSelectedUser] = useState(null); // For private chat
        const messagesEndRef = useRef(null);

        // Auto-scroll to bottom of messages
        useEffect(() => {
            scrollToBottom();
        }, [messages]);

        const scrollToBottom = () => {
            if (messagesEndRef.current) {
                messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
        };

        // WebSocket connection handling
        useEffect(() => {
            if (token) {
                try {
                    // Decode JWT token
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const payload = JSON.parse(window.atob(base64));

                    setUser({ username: payload.username });
                    setView('chat');
                    connectWebSocket(token);
                } catch (error) {
                    console.error('Invalid token:', error);
                    localStorage.removeItem('token');
                    setToken('');
                }
            }
        }, []);

        const connectWebSocket = (authToken) => {
            const socket = new WebSocket(`ws://${window.location.host}/ws?token=${authToken}`);

            socket.onopen = () => {
                console.log('WebSocket connected');
                setWs(socket);
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'users') {
                    // Receive list of online users
                    setOnlineUsers(data.users);
                } else if (data.type === 'user_joined') {
                    // User joined notification
                    setOnlineUsers(prev => [...prev, data.username]);
                } else if (data.type === 'user_left') {
                    // User left notification
                    setOnlineUsers(prev => prev.filter(u => u !== data.username));
                } else {
                    // Regular message (private or public)
                    setMessages(prevMessages => [...prevMessages, data]);
                }
            };

            socket.onclose = () => {
                console.log('WebSocket closed');
                setWs(null);
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            setError('');

            if (!loginForm.username.trim() || !loginForm.password.trim()) {
                setError('Username and password are required');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginForm),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('token', data.token);
                setToken(data.token);
                setUser(data.user);
                setView('chat');
                connectWebSocket(data.token);
            } catch (error) {
                console.error('Login error:', error);
                setError(error.message);
            }
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            setError('');

            console.log('Form values at submission:', registerForm);
            const body = JSON.stringify(registerForm);
            console.log('Request payload:', body); // Debug the actual request body

            if (registerForm.password.length < 6) {
                setError('Password must be at least 6 characters');
                return;
            }

            if (!registerForm.username.trim()) {
                setError('Username is required');
                return;
            }

            if (!registerForm.password.trim()) {
                setError('Password is required');
                return;
            }
            try {
                const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: registerForm.username.trim(),
                            password: registerForm.password,
                            email: registerForm.email
                        }),
                    });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Registration failed');
                }

                const data = await response.json();
                localStorage.setItem('token', data.token);
                setToken(data.token);
                setUser(data.user);
                setView('chat');
                connectWebSocket(data.token);
            } catch (error) {
                console.error('Registration error:', error);
                setError(error.message);
            }
        };

        const handleLogout = () => {
            localStorage.removeItem('token');
            setToken('');
            setUser(null);
            setView('login');
            if (ws) {
                ws.close();
            }
        };

        const sendMessage = (e) => {
            e.preventDefault();
            if (!newMessage.trim() || !ws) return;

            const messageObj = {
                content: newMessage,
                recipient: selectedUser, // Will be null for group chat
                isPrivate: !!selectedUser
            };

            ws.send(JSON.stringify(messageObj));
            setNewMessage('');
        };

        const selectUser = (username) => {
            if (username === user.username) return; // Can't chat with yourself
            setSelectedUser(username === 'Group Chat' ? null : username);
        };

        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        // Filter messages based on selected chat
        const filteredMessages = messages.filter(msg => {
            if (!selectedUser) {
                // Group chat - show only public messages
                return !msg.isPrivate;
            } else {
                // Private chat - show only messages between current user and selected user
                return msg.isPrivate &&
                    ((msg.username === selectedUser && msg.recipient === user.username) ||
                        (msg.username === user.username && msg.recipient === selectedUser));
            }
        });

        const renderLoginForm = () => (
            <div className="flex items-center justify-center h-full">
                <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                    <h1 className="text-2xl font-bold text-center mb-6">Login to Go Chat</h1>
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">{error}</div>}
                    <form onSubmit={handleLogin}>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
                                Username
                            </label>
                            <input
                                id="username"
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={loginForm.username}
                                onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                placeholder="Enter your username"
                                required
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                                Password
                            </label>
                            <input
                                id="password"
                                type="password"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={loginForm.password}
                                onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                placeholder="Enter your password"
                                required
                            />
                        </div>
                        <div className="flex items-center justify-between">
                            <button
                                type="submit"
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            >
                                Login
                            </button>
                            <button
                                type="button"
                                className="text-blue-500 hover:text-blue-700 font-bold"
                                onClick={() => setView('register')}
                            >
                                Register
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );

        const renderRegisterForm = () => (
            <div className="flex items-center justify-center h-full">
                <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                    <h1 className="text-2xl font-bold text-center mb-6">Register for Go Chat</h1>
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">{error}</div>}
                    <form onSubmit={handleRegister}>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-username">
                                Username
                            </label>
                            <input
                                id="reg-username"
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.username}
                                onChange={(e) => setRegisterForm({...registerForm, username: e.target.value})}
                                placeholder="Choose a username"
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-email">
                                Email (optional)
                            </label>
                            <input
                                id="reg-email"
                                type="email"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.email}
                                onChange={(e) => setRegisterForm({...registerForm, email: e.target.value})}
                                placeholder="Enter your email"
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-password">
                                Password
                            </label>
                            <input
                                id="reg-password"
                                type="password"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.password}
                                onChange={(e) => setRegisterForm({...registerForm, password: e.target.value})}
                                placeholder="Choose a password"
                                required
                            />
                            <p className="text-gray-600 text-xs mt-1">Password must be at least 6 characters long</p>
                        </div>
                        <div className="flex items-center justify-between">
                            <button
                                type="submit"
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            >
                                Register
                            </button>
                            <button
                                type="button"
                                className="text-blue-500 hover:text-blue-700 font-bold"
                                onClick={() => setView('login')}
                            >
                                Login
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );

        const renderChat = () => (
            <div className="flex flex-col h-full max-w-6xl mx-auto p-4">
                <div className="bg-white rounded-lg shadow-md flex flex-col h-full">
                    <div className="bg-blue-500 text-white p-4 rounded-t-lg flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold">Go Chat</h1>
                            <p className="text-sm">Logged in as {user.username}</p>
                        </div>
                        <button
                            onClick={handleLogout}
                            className="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded"
                        >
                            Logout
                        </button>
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Online users sidebar */}
                        <div className="w-1/4 border-r p-4">
                            <h2 className="font-bold mb-2">Chats</h2>
                            <div className="overflow-y-auto max-h-full">
                                <div
                                    className={`p-2 rounded mb-1 cursor-pointer ${!selectedUser ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                                    onClick={() => selectUser('Group Chat')}
                                >
                                    Group Chat
                                </div>
                                {onlineUsers.filter(u => u !== user.username).map(username => (
                                    <div
                                        key={username}
                                        className={`p-2 rounded mb-1 cursor-pointer ${selectedUser === username ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                                        onClick={() => selectUser(username)}
                                    >
                                        {username}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Chat area */}
                        <div className="w-3/4 flex flex-col">
                            <div className="p-2 border-b bg-gray-100">
                                <span className="font-bold">{selectedUser || 'Group Chat'}</span>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {filteredMessages.map((msg, idx) => (
                                    <div
                                        key={msg.id || idx}
                                        className={`flex ${msg.username === user.username ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                                msg.username === user.username
                                                    ? 'bg-blue-500 text-white'
                                                    : 'bg-gray-200 text-gray-800'
                                            }`}
                                        >
                                            {msg.username !== user.username && (
                                                <div className="font-bold text-sm">{msg.username}</div>
                                            )}
                                            <div>{msg.content}</div>
                                            <div className="text-xs text-right mt-1 opacity-75">
                                                {formatTime(msg.timestamp)}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="border-t p-4">
                                <form onSubmit={sendMessage} className="flex">
                                    <input
                                        type="text"
                                        className="flex-1 border rounded-l-lg py-2 px-3 focus:outline-none"
                                        value={newMessage}
                                        onChange={(e) => setNewMessage(e.target.value)}
                                        placeholder={`Message ${selectedUser || 'everyone'}...`}
                                    />
                                    <button
                                        type="submit"
                                        className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-lg"
                                    >
                                        Send
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        if (view === 'login') {
            return renderLoginForm();
        } else if (view === 'register') {
            return renderRegisterForm();
        } else {
            return renderChat();
        }
    }

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>