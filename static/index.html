<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="bg-gray-100 h-screen">
<div id="root" class="h-full"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
        const [user, setUser] = useState(null);
        const [token, setToken] = useState(localStorage.getItem('token') || '');
        const [view, setView] = useState('login');
        const [loginForm, setLoginForm] = useState({ username: '', password: '' });
        const [registerForm, setRegisterForm] = useState({ username: '', password: '', email: '' });
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [ws, setWs] = useState(null);
        const [error, setError] = useState('');
        const [onlineUsers, setOnlineUsers] = useState([]);
        const [selectedUser, setSelectedUser] = useState(null); // For private chat
        const [friends, setFriends] = useState([]); // New state for friends
        const [pendingRequests, setPendingRequests] = useState([]); // New state for pending friend requests
        const [showAddFriend, setShowAddFriend] = useState(false); // UI state for add friend form
        const [newFriendUsername, setNewFriendUsername] = useState(''); // State for new friend username
        const [showFriendRequests, setShowFriendRequests] = useState(false); // UI state for friend requests panel
        const [activeTab, setActiveTab] = useState('chat'); // 'chat' or 'friends'
        const messagesEndRef = useRef(null);

        // Auto-scroll to bottom of messages
        useEffect(() => {
            if (messagesEndRef.current) {
                scrollToBottom();
            }
            
            return () => {
                // No cleanup needed for scroll, but adding for consistency
            };
        }, [messages]);

        const scrollToBottom = () => {
            if (messagesEndRef.current) {
                messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
        };

        // Add an effect to cleanup WebSocket connection on unmount
        useEffect(() => {
            // No setup needed, just cleanup
            return () => {
                if (ws) {
                    console.log("Closing WebSocket connection due to component unmount");
                    ws.close();
                }
            };
        }, [ws]);

        // WebSocket connection handling
        useEffect(() => {
            let isComponentMounted = true;
            
            const initializeUser = async () => {
                if (!token || !isComponentMounted) return;
                
                try {
                    // Decode JWT token
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const payload = JSON.parse(window.atob(base64));

                    if (isComponentMounted) {
                        setUser({ username: payload.username });
                        setView('chat');
                        connectWebSocket(token);
                        
                        // We'll chain these promises to avoid race conditions
                        try {
                            await fetchFriends();
                            if (isComponentMounted) {
                                await fetchPendingRequests();
                            }
                        } catch (err) {
                            console.error("Error initializing data:", err);
                        }
                    }
                } catch (error) {
                    console.error('Invalid token:', error);
                    if (isComponentMounted) {
                        localStorage.removeItem('token');
                        setToken('');
                    }
                }
            };
            
            initializeUser();
            
            // Cleanup function
            return () => {
                isComponentMounted = false;
                // Close WebSocket connection if it exists
                if (ws) {
                    ws.close();
                }
            };
        }, [token]); // Add token as a dependency to respond to token changes

        const connectWebSocket = (authToken) => {
            try {
                const socket = new WebSocket(`ws://${window.location.host}/ws?token=${authToken}`);

                socket.onopen = () => {
                    console.log('WebSocket connected');
                    setWs(socket);
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'users') {
                            // Receive list of online users
                            setOnlineUsers(data.users || []);
                        } else if (data.type === 'user_joined') {
                            // User joined notification
                            setOnlineUsers(prev => [...(prev || []), data.username]);
                        } else if (data.type === 'user_left') {
                            // User left notification
                            setOnlineUsers(prev => (prev || []).filter(u => u !== data.username));
                        } else {
                            // Regular message (private or public)
                            setMessages(prevMessages => [...(prevMessages || []), data]);
                        }
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };

                socket.onclose = () => {
                    console.log('WebSocket closed');
                    setWs(null);
                };

                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
            }
        };

        // Fetch friends list
        const fetchFriends = async () => {
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch friends');
                }
                
                const data = await response.json();
                if (isMounted) {
                    setFriends(data);
                }
            } catch (error) {
                console.error('Error fetching friends:', error);
                // Only update state if component is still mounted
                if (isMounted) {
                    setError('Error fetching friends');
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        // Fetch pending friend requests
        const fetchPendingRequests = async () => {
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends/pending', {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch pending requests');
                }
                
                const data = await response.json();
                if (isMounted) {
                    setPendingRequests(data);
                }
            } catch (error) {
                console.error('Error fetching pending requests:', error);
                if (isMounted) {
                    setError('Error fetching friend requests');
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        // Handle sending friend request
        const sendFriendRequest = async (e) => {
            e.preventDefault();
            if (!newFriendUsername.trim()) return;
            
            let timeoutId;
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        friend_username: newFriendUsername.trim()
                    }),
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to send friend request');
                }
                
                if (isMounted) {
                    setNewFriendUsername('');
                    setShowAddFriend(false);
                    setError('Friend request sent successfully!');
                    
                    // Clear the success message after 3 seconds
                    timeoutId = setTimeout(() => {
                        if (isMounted) {
                            setError('');
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            // Cleanup function to be used if needed
            return () => {
                isMounted = false;
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
            };
        };

        // Handle accepting friend request
        const acceptFriendRequest = async (username) => {
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends/accept', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        friend_username: username
                    }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to accept friend request');
                }
                
                if (isMounted) {
                    fetchFriends();
                    fetchPendingRequests();
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        // Handle declining friend request
        const declineFriendRequest = async (username) => {
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends/decline', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        friend_username: username
                    }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to decline friend request');
                }
                
                if (isMounted) {
                    fetchPendingRequests();
                }
            } catch (error) {
                console.error('Error declining friend request:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        // Handle removing friend
        const removeFriend = async (username) => {
            if (!confirm(`Are you sure you want to remove ${username} from your friends?`)) {
                return;
            }
            
            let isMounted = true;
            
            try {
                const response = await fetch('/api/friends/remove', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        friend_username: username
                    }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove friend');
                }
                
                if (isMounted) {
                    fetchFriends();
                    if (selectedUser === username) {
                        setSelectedUser(null); // Reset selected user if removed
                    }
                }
            } catch (error) {
                console.error('Error removing friend:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            setError('');
            let isMounted = true;

            if (!loginForm.username.trim() || !loginForm.password.trim()) {
                setError('Username and password are required');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginForm),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Login failed');
                }

                const data = await response.json();
                
                if (isMounted) {
                    localStorage.setItem('token', data.token);
                    setToken(data.token);
                    setUser(data.user);
                    setView('chat');
                    connectWebSocket(data.token);
                    fetchFriends();
                    fetchPendingRequests();
                }
            } catch (error) {
                console.error('Login error:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            setError('');
            let isMounted = true;

            console.log('Form values at submission:', registerForm);
            const body = JSON.stringify(registerForm);
            console.log('Request payload:', body); // Debug the actual request body

            if (registerForm.password.length < 6) {
                setError('Password must be at least 6 characters');
                return;
            }

            if (!registerForm.username.trim()) {
                setError('Username is required');
                return;
            }

            if (!registerForm.password.trim()) {
                setError('Password is required');
                return;
            }
            try {
                const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: registerForm.username.trim(),
                            password: registerForm.password,
                            email: registerForm.email
                        }),
                    });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Registration failed');
                }

                const data = await response.json();
                
                if (isMounted) {
                    localStorage.setItem('token', data.token);
                    setToken(data.token);
                    setUser(data.user);
                    setView('chat');
                    connectWebSocket(data.token);
                    fetchFriends();
                    fetchPendingRequests();
                }
            } catch (error) {
                console.error('Registration error:', error);
                if (isMounted) {
                    setError(error.message);
                }
            }
            
            return () => {
                isMounted = false;
            };
        };

        const handleLogout = () => {
            localStorage.removeItem('token');
            setToken('');
            setUser(null);
            setView('login');
            if (ws) {
                ws.close();
            }
        };

        const sendMessage = (e) => {
            e.preventDefault();
            if (!newMessage.trim() || !ws) return;

            const messageObj = {
                content: newMessage,
                recipient: selectedUser, // Will be null for group chat
                isPrivate: !!selectedUser
            };

            ws.send(JSON.stringify(messageObj));
            setNewMessage('');
        };

        const selectUser = (username) => {
            if (user && username === user.username) return; // Can't chat with yourself
            setSelectedUser(username === 'Group Chat' ? null : username);
            setActiveTab('chat'); // Switch to chat tab when selecting a user
        };

        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        // Filter messages based on selected chat
        const filteredMessages = messages ? messages.filter(msg => {
            if (!selectedUser) {
                // Group chat - show only public messages
                return !msg.isPrivate;
            } else {
                // Private chat - show only messages between current user and selected user
                return msg.isPrivate &&
                    ((msg.username === selectedUser && msg.recipient === (user && user.username)) ||
                        (msg.username === (user && user.username) && msg.recipient === selectedUser));
            }
        }) : [];

        const renderLoginForm = () => (
            <div className="flex items-center justify-center h-full">
                <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                    <h1 className="text-2xl font-bold text-center mb-6">Login to Go Chat</h1>
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">{error}</div>}
                    <form onSubmit={handleLogin}>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
                                Username
                            </label>
                            <input
                                id="username"
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={loginForm.username}
                                onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                placeholder="Enter your username"
                                required
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                                Password
                            </label>
                            <input
                                id="password"
                                type="password"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={loginForm.password}
                                onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                placeholder="Enter your password"
                                required
                            />
                        </div>
                        <div className="flex items-center justify-between">
                            <button
                                type="submit"
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            >
                                Login
                            </button>
                            <button
                                type="button"
                                className="text-blue-500 hover:text-blue-700 font-bold"
                                onClick={() => setView('register')}
                            >
                                Register
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );

        const renderRegisterForm = () => (
            <div className="flex items-center justify-center h-full">
                <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                    <h1 className="text-2xl font-bold text-center mb-6">Register for Go Chat</h1>
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">{error}</div>}
                    <form onSubmit={handleRegister}>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-username">
                                Username
                            </label>
                            <input
                                id="reg-username"
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.username}
                                onChange={(e) => setRegisterForm({...registerForm, username: e.target.value})}
                                placeholder="Choose a username"
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-email">
                                Email (optional)
                            </label>
                            <input
                                id="reg-email"
                                type="email"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.email}
                                onChange={(e) => setRegisterForm({...registerForm, email: e.target.value})}
                                placeholder="Enter your email"
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-password">
                                Password
                            </label>
                            <input
                                id="reg-password"
                                type="password"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                value={registerForm.password}
                                onChange={(e) => setRegisterForm({...registerForm, password: e.target.value})}
                                placeholder="Choose a password"
                                required
                            />
                            <p className="text-gray-500 text-xs mt-1">Password must be at least 6 characters</p>
                        </div>
                        <div className="flex items-center justify-between">
                            <button
                                type="submit"
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            >
                                Register
                            </button>
                            <button
                                type="button"
                                className="text-blue-500 hover:text-blue-700 font-bold"
                                onClick={() => setView('login')}
                            >
                                Back to Login
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );

        const renderNavBar = () => (
            <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div className="font-bold text-xl">Go Chat</div>
                <div className="flex items-center">
                    <div className="mr-4">{user && `Welcome, ${user.username}`}</div>
                    <button
                        className="bg-blue-700 hover:bg-blue-800 text-white font-bold py-1 px-3 rounded focus:outline-none focus:shadow-outline"
                        onClick={handleLogout}
                    >
                        Logout
                    </button>
                </div>
            </div>
        );

        const renderSidebar = () => (
            <div className="w-1/4 bg-gray-200 p-4 overflow-auto h-full flex flex-col">
                <div className="mb-4 flex">
                    <button
                        className={`${activeTab === 'chat' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700'} flex-1 font-bold py-2 px-4 rounded-l focus:outline-none`}
                        onClick={() => setActiveTab('chat')}
                    >
                        Chat
                    </button>
                    <button
                        className={`${activeTab === 'friends' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700'} flex-1 font-bold py-2 px-4 rounded-r focus:outline-none relative`}
                        onClick={() => setActiveTab('friends')}
                    >
                        Friends
                        {pendingRequests && pendingRequests.length > 0 && (
                            <span className="absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                                {pendingRequests.length}
                            </span>
                        )}
                    </button>
                </div>

                {activeTab === 'chat' ? (
                    // Chat users sidebar
                    <div>
                        <h2 className="text-lg font-bold mb-2">Chats</h2>
                        <div className="mb-4">
                            <div
                                className={`py-2 px-3 rounded cursor-pointer mb-1 ${!selectedUser ? 'bg-blue-500 text-white' : 'hover:bg-gray-300'}`}
                                onClick={() => selectUser('Group Chat')}
                            >
                                Group Chat
                            </div>
                        </div>

                        <h2 className="text-lg font-bold mb-2">Friends</h2>
                        <div className="mb-4">
                            {friends && friends.length > 0 ? (
                                friends.map(friend => (
                                    <div
                                        key={friend.username}
                                        className={`py-2 px-3 rounded cursor-pointer mb-1 ${selectedUser === friend.username ? 'bg-blue-500 text-white' : 'hover:bg-gray-300'}`}
                                        onClick={() => selectUser(friend.username)}
                                    >
                                        {friend.username}
                                    </div>
                                ))
                            ) : (
                                <p className="text-gray-500 text-sm">No friends yet</p>
                            )}
                        </div>

                        <h2 className="text-lg font-bold mb-2">Online Users</h2>
                        <div>
                            {onlineUsers && onlineUsers.filter(username => user && username !== user.username).map(username => (
                                <div
                                    key={username}
                                    className={`py-2 px-3 rounded cursor-pointer mb-1 ${selectedUser === username ? 'bg-blue-500 text-white' : 'hover:bg-gray-300'}`}
                                    onClick={() => selectUser(username)}
                                >
                                    {username}
                                    {friends && friends.some(f => f.username === username) && (
                                        <span className="text-xs text-green-600 ml-1">(Friend)</span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    // Friends management sidebar
                    <div>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold">Friends</h2>
                            <button
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-sm"
                                onClick={() => setShowAddFriend(!showAddFriend)}
                            >
                                {showAddFriend ? 'Cancel' : 'Add Friend'}
                            </button>
                        </div>

                        {/* Add friend form */}
                        {showAddFriend && (
                            <div className="mb-4 bg-white p-3 rounded shadow">
                                <form onSubmit={sendFriendRequest}>
                                    <input
                                        type="text"
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2"
                                        value={newFriendUsername}
                                        onChange={(e) => setNewFriendUsername(e.target.value)}
                                        placeholder="Username"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded focus:outline-none focus:shadow-outline w-full"
                                    >
                                        Send Request
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* Friend requests button */}
                        <button
                            className="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mb-4 flex justify-between items-center"
                            onClick={() => setShowFriendRequests(!showFriendRequests)}
                        >
                            <span>Friend Requests</span>
                            {pendingRequests && pendingRequests.length > 0 && (
                                <span className="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                                    {pendingRequests.length}
                                </span>
                            )}
                        </button>

                        {/* Friend requests panel */}
                        {showFriendRequests && (
                            <div className="mb-4 bg-white p-3 rounded shadow">
                                <h3 className="font-bold mb-2">Pending Requests</h3>
                                {pendingRequests && pendingRequests.length === 0 ? (
                                    <p className="text-gray-500 text-sm">No pending friend requests</p>
                                ) : pendingRequests ? (
                                    pendingRequests.map(request => (
                                        <div key={request.username} className="flex justify-between items-center mb-2 pb-2 border-b">
                                            <span>{request.username}</span>
                                            <div>
                                                <button
                                                    className="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs mr-1"
                                                    onClick={() => acceptFriendRequest(request.username)}
                                                >
                                                    Accept
                                                </button>
                                                <button
                                                    className="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs"
                                                    onClick={() => declineFriendRequest(request.username)}
                                                >
                                                    Decline
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-gray-500 text-sm">Loading requests...</p>
                                )}
                            </div>
                        )}

                        {/* Friends list */}
                        <h3 className="font-bold mb-2">My Friends</h3>
                        {friends && friends.length === 0 ? (
                            <p className="text-gray-500 text-sm">You don't have any friends yet</p>
                        ) : friends ? (
                            friends.map(friend => (
                                <div key={friend.username} className="flex justify-between items-center mb-2 pb-2 border-b">
                                    <span>{friend.username}</span>
                                    <div className="flex">
                                        <button
                                            className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs mr-1"
                                            onClick={() => selectUser(friend.username)}
                                        >
                                            Chat
                                        </button>
                                        <button
                                            className="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs"
                                            onClick={() => removeFriend(friend.username)}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <p className="text-gray-500 text-sm">Loading friends...</p>
                        )}
                    </div>
                )}
            </div>
        );

        const renderChatInterface = () => (
            <div className="w-3/4 flex flex-col h-full bg-white border-l">
                <div className="p-4 border-b flex justify-between items-center">
                    <h2 className="text-xl font-bold">
                        {selectedUser ? `Chat with ${selectedUser}` : 'Group Chat'}
                    </h2>
                    {selectedUser && friends && !friends.some(f => f.username === selectedUser) && (
                        <button
                            className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded focus:outline-none focus:shadow-outline text-sm"
                            onClick={() => {
                                setNewFriendUsername(selectedUser);
                                sendFriendRequest({ preventDefault: () => {} });
                            }}
                        >
                            Add as Friend
                        </button>
                    )}
                </div>
                <div className="flex-1 overflow-auto p-4">
                    {filteredMessages && filteredMessages.length > 0 ? (
                        filteredMessages.map((msg, index) => (
                            <div
                                key={index}
                                className={`mb-3 ${msg.username === (user && user.username) ? 'text-right' : ''}`}
                            >
                                <div
                                    className={`inline-block rounded px-4 py-2 max-w-xs ${
                                        msg.username === (user && user.username)
                                            ? 'bg-blue-500 text-white'
                                            : 'bg-gray-200 text-gray-800'
                                    }`}
                                >
                                    {msg.username !== (user && user.username) && (
                                        <div className="font-bold text-sm">{msg.username}</div>
                                    )}
                                    <div>{msg.content}</div>
                                    <div className="text-xs mt-1 opacity-75">{formatTime(msg.timestamp)}</div>
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-center text-gray-500 mt-4">No messages yet</p>
                    )}
                    <div ref={messagesEndRef} />
                </div>
                <div className="p-4 border-t">
                    <form onSubmit={sendMessage} className="flex">
                        <input
                            type="text"
                            className="flex-1 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            placeholder="Type a message..."
                        />
                        <button
                            type="submit"
                            className="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            disabled={!ws}
                        >
                            Send
                        </button>
                    </form>
                </div>
            </div>
        );

        const renderContent = () => {
            switch (view) {
                case 'login':
                    return renderLoginForm();
                case 'register':
                    return renderRegisterForm();
                default:
                    return (
                        <div className="flex flex-col h-full">
                            {renderNavBar()}
                            <div className="flex flex-1 overflow-hidden">
                                {renderSidebar()}
                                {renderChatInterface()}
                            </div>
                        </div>
                    );
            }
        };

        return (
            <div className="h-full">
                {renderContent()}
            </div>
        );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>